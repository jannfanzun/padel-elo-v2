<%- include('../partials/header') %>

<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="card shadow-lg border-0" style="border-radius: 15px; overflow: hidden;">
      <!-- Tournament Header -->
      <div class="card-header text-white text-center py-4" style="background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);">
        <h1 class="mb-3">
          <i class="fas fa-trophy me-3" style="animation: bounce 2s infinite;"></i>
          Spieltag Generator
        </h1>
        <p class="fs-5 mb-0">Erstelle automatisch ausbalancierte Turniere basierend auf ELO-Bewertungen</p>
        <div class="mt-3 bg-white bg-opacity-20 rounded-pill py-2 px-4 d-inline-block">
          <span id="stepIndicator">Schritt 1: Spieleranzahl wählen</span>
        </div>
      </div>
      
      <div class="card-body p-4">
        <!-- Step 1: Player Count Selection -->
        <div id="step1" class="fade-in">
          <h3 class="mb-4 text-center text-primary">
            <i class="fas fa-users me-2"></i>Wie viele Spieler nehmen teil?
          </h3>
          <div class="row g-3">
            <% [4, 8, 12, 16, 20, 24].forEach((count, index) => { %>
              <div class="col-md-4 col-6">
                <div class="player-count-card card h-100 text-center border-2 border-transparent" 
                     data-count="<%= count %>" 
                     style="cursor: pointer; transition: all 0.3s ease; background: linear-gradient(45deg, #f8f9fa, white);">
                  <div class="card-body p-3">
                    <h4 class="text-primary mb-2"><%= count %> Spieler</h4>
                    <p class="text-muted mb-0"><%= count / 4 %> <%= count / 4 === 1 ? 'Platz' : 'Plätze' %></p>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        </div>
        
        <!-- Step 2: Player Selection -->
        <div id="step2" class="d-none fade-in">
          <h3 class="mb-4 text-center text-primary">
            <i class="fas fa-user-check me-2"></i>Spieler auswählen
          </h3>
          <div class="row">
            <div class="col-md-6">
              <h5>Verfügbare Spieler:</h5>
              <p class="text-muted small">Sortiert nach ELO-Rating (höchste zuerst)</p>
              <div id="availablePlayers" class="border rounded p-3" 
                   style="max-height: 400px; overflow-y: auto; background: linear-gradient(45deg, #f8f9fa, white);">
                <% users.forEach(user => { %>
                  <div class="available-player-item player-item border rounded p-2 mb-2 d-flex justify-content-between align-items-center bg-white"
                       data-username="<%= user.username %>" 
                       data-elo="<%= user.eloRating %>"
                       style="cursor: pointer; transition: all 0.3s ease;">
                    <div>
                      <strong><%= user.username %></strong>
                      <span class="elo-badge ms-2"><%= user.eloRating %> ELO</span>
                    </div>
                    <button class="btn btn-sm btn-outline-primary add-player-btn">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                <% }); %>
              </div>
            </div>
            
            <div class="col-md-6">
              <h5>Ausgewählte Spieler (<span id="selectedCount">0</span>/<span id="maxPlayers">8</span>):</h5>
              <div id="selectedPlayers" class="border rounded p-3" 
                   style="min-height: 300px; max-height: 400px; overflow-y: auto; background: linear-gradient(45deg, #f8f9fa, white);">
                <p class="text-muted text-center m-0">Noch keine Spieler ausgewählt</p>
              </div>
              
              <div class="mt-3 text-center">
                <button class="btn btn-success btn-lg px-5" id="generateTournamentBtn" disabled
                        style="background: linear-gradient(135deg, #198754 0%, #157347 100%); border: none; border-radius: 25px;">
                  <i class="fas fa-magic me-2"></i>Spieltag generieren
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Step 3: Tournament Results -->
        <div id="step3" class="d-none fade-in">
          <h3 class="mb-4 text-center text-primary">
            <i class="fas fa-list me-2"></i>Generierter Spieltag
          </h3>
          <div id="tournamentResults"></div>
          
          <div class="text-center mt-4">
            <button class="btn btn-outline-primary me-3" id="regenerateBtn">
              <i class="fas fa-redo me-2"></i>Neu generieren
            </button>
            <button class="btn btn-primary" id="newTournamentBtn">
              <i class="fas fa-plus me-2"></i>Neues Turnier
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .fade-in {
    animation: fadeIn 0.5s ease-in;
  }
  
  .player-count-card:hover {
    border-color: #0d6efd !important;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(13, 110, 253, 0.15);
  }
  
  .player-count-card.selected {
    border-color: #0d6efd !important;
    background: #e7f1ff !important;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(13, 110, 253, 0.2);
  }
  
  .player-item:hover {
    border-color: #0d6efd !important;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
  }
  
  .player-item.disabled {
    opacity: 0.5;
    cursor: not-allowed !important;
  }
  
  .player-item.disabled:hover {
    border-color: #e9ecef !important;
    box-shadow: none;
  }
  
  .court-assignment {
    background: linear-gradient(45deg, #f8f9fa, white);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border-left: 4px solid #0d6efd;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }
  
  .court-number {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
  }
  
  .vs-indicator {
    background: #0d6efd;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
  }
  
  .team-players {
    background: rgba(13, 110, 253, 0.1);
    border-radius: 8px;
    padding: 0.8rem;
    margin: 0.3rem 0;
  }
  
  .elo-badge {
    background: #0d6efd;
    color: white;
    padding: 0.2rem 0.6rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedPlayerCount = 0;
    let selectedPlayers = [];
    let currentStep = 1;
    
    // Step 1: Player count selection
    document.querySelectorAll('.player-count-card').forEach(card => {
        card.addEventListener('click', function() {
            // Remove previous selection
            document.querySelectorAll('.player-count-card').forEach(c => 
                c.classList.remove('selected'));
            
            // Add selection to clicked card
            this.classList.add('selected');
            selectedPlayerCount = parseInt(this.dataset.count);
            
            // Update UI and proceed to step 2
            setTimeout(() => {
                showStep(2);
                document.getElementById('maxPlayers').textContent = selectedPlayerCount;
                updateAvailablePlayersVisibility();
            }, 500);
        });
    });
    
    // Step 2: Add/Remove players
    document.addEventListener('click', function(e) {
        if (e.target.closest('.add-player-btn')) {
            e.preventDefault();
            const playerItem = e.target.closest('.available-player-item');
            addPlayer(playerItem);
        }
        
        if (e.target.closest('.remove-player-btn')) {
            e.preventDefault();
            const playerItem = e.target.closest('.selected-player-item');
            removePlayer(playerItem);
        }
    });
    
    // Step 3: Generate tournament
    document.getElementById('generateTournamentBtn').addEventListener('click', generateTournament);
    document.getElementById('regenerateBtn').addEventListener('click', generateTournament);
    document.getElementById('newTournamentBtn').addEventListener('click', resetTournament);
    
    function showStep(step) {
        // Hide all steps
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`step${i}`).classList.add('d-none');
        }
        
        // Show current step
        document.getElementById(`step${step}`).classList.remove('d-none');
        currentStep = step;
        
        // Update step indicator
        const indicators = [
            'Schritt 1: Spieleranzahl wählen',
            'Schritt 2: Spieler auswählen',
            'Schritt 3: Turnier generiert'
        ];
        document.getElementById('stepIndicator').textContent = indicators[step - 1];
    }
    
    function addPlayer(playerItem) {
        if (selectedPlayers.length >= selectedPlayerCount) {
            alert(`Maximum von ${selectedPlayerCount} Spielern erreicht`);
            return;
        }
        
        const username = playerItem.dataset.username;
        const elo = parseInt(playerItem.dataset.elo);
        
        // Check if already selected
        if (selectedPlayers.some(p => p.username === username)) {
            return;
        }
        
        selectedPlayers.push({ username, elo });
        updateSelectedPlayersList();
        updateAvailablePlayersVisibility();
    }
    
    function removePlayer(playerItem) {
        const username = playerItem.dataset.username;
        selectedPlayers = selectedPlayers.filter(p => p.username !== username);
        updateSelectedPlayersList();
        updateAvailablePlayersVisibility();
    }
    
    function updateSelectedPlayersList() {
        const container = document.getElementById('selectedPlayers');
        const countSpan = document.getElementById('selectedCount');
        const generateBtn = document.getElementById('generateTournamentBtn');
        
        countSpan.textContent = selectedPlayers.length;
        
        if (selectedPlayers.length === 0) {
            container.innerHTML = '<p class="text-muted text-center m-0">Noch keine Spieler ausgewählt</p>';
        } else {
            // Sort by ELO for display
            const sortedPlayers = [...selectedPlayers].sort((a, b) => b.elo - a.elo);
            
            container.innerHTML = sortedPlayers.map(player => `
                <div class="selected-player-item player-item border rounded p-2 mb-2 d-flex justify-content-between align-items-center bg-white"
                     data-username="${player.username}">
                    <div>
                        <strong>${player.username}</strong>
                        <span class="elo-badge ms-2">${player.elo} ELO</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-player-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Enable generate button if we have the right number of players
        generateBtn.disabled = selectedPlayers.length !== selectedPlayerCount;
    }
    
    function updateAvailablePlayersVisibility() {
        document.querySelectorAll('.available-player-item').forEach(item => {
            const username = item.dataset.username;
            const isSelected = selectedPlayers.some(p => p.username === username);
            const isMaxReached = selectedPlayers.length >= selectedPlayerCount;
            
            if (isSelected || (isMaxReached && !isSelected)) {
                item.classList.add('disabled');
                item.querySelector('.add-player-btn').disabled = true;
            } else {
                item.classList.remove('disabled');
                item.querySelector('.add-player-btn').disabled = false;
            }
        });
    }
    
    function generateTournament() {
        if (selectedPlayers.length !== selectedPlayerCount) {
            alert(`Benötigt genau ${selectedPlayerCount} Spieler`);
            return;
        }
        
        // Sort players by ELO (strongest to weakest)
        const sortedPlayers = [...selectedPlayers].sort((a, b) => b.elo - a.elo);
        
        // Create courts (every 4 players = 1 court)
        const courts = [];
        const courtsCount = selectedPlayerCount / 4;
        
        for (let court = 0; court < courtsCount; court++) {
            const startIndex = court * 4;
            const courtPlayers = sortedPlayers.slice(startIndex, startIndex + 4);
            
            // Create balanced teams: 1st+4th vs 2nd+3rd strongest in this group
            const team1 = [courtPlayers[0], courtPlayers[3]];
            const team2 = [courtPlayers[1], courtPlayers[2]];
            
            courts.push({
                number: court + 1,
                team1,
                team2
            });
        }
        
        displayTournamentResults(courts);
        showStep(3);
    }
    
    function displayTournamentResults(courts) {
        const resultsDiv = document.getElementById('tournamentResults');
        
        const html = courts.map(court => `
            <div class="court-assignment">
                <div class="d-flex align-items-center mb-3">
                    <div class="court-number me-3">${court.number}</div>
                    <h5 class="mb-0">Platz ${court.number}</h5>
                </div>
                
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <div class="team-players">
                            <h6 class="text-primary mb-2">Team 1</h6>
                            ${court.team1.map(player => `
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span><strong>${player.username}</strong></span>
                                    <span class="elo-badge">${player.elo}</span>
                                </div>
                            `).join('')}
                            <div class="mt-2">
                                <small class="text-muted">
                                    Durchschnitts-ELO: ${Math.round((court.team1[0].elo + court.team1[1].elo) / 2)}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2 text-center">
                        <div class="vs-indicator">VS</div>
                    </div>
                    
                    <div class="col-md-5">
                        <div class="team-players">
                            <h6 class="text-primary mb-2">Team 2</h6>
                            ${court.team2.map(player => `
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span><strong>${player.username}</strong></span>
                                    <span class="elo-badge">${player.elo}</span>
                                </div>
                            `).join('')}
                            <div class="mt-2">
                                <small class="text-muted">
                                    Durchschnitts-ELO: ${Math.round((court.team2[0].elo + court.team2[1].elo) / 2)}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        resultsDiv.innerHTML = html;
    }
    
    function resetTournament() {
        selectedPlayers = [];
        selectedPlayerCount = 0;
        document.querySelectorAll('.player-count-card').forEach(card => 
            card.classList.remove('selected'));
        updateSelectedPlayersList();
        updateAvailablePlayersVisibility();
        showStep(1);
    }
});
</script>

<%- include('../partials/footer') %>