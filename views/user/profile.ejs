<%- include('../partials/header') %>

<div class="row">
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0">Spielerprofil</h2>
        </div>
        <div class="card-body text-center">
          <div class="mb-3">
            <span class="display-1 text-primary mb-0">
              <i class="fas fa-user-circle"></i>
            </span>
          </div>
          
          <h3 class="mb-0"><%= user.username %></h3>
          <p class="text-muted"><%= user.email %></p>
          
          <div class="mb-3">
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
              <i class="fas fa-edit me-1"></i>Profil bearbeiten
            </button>
          </div>
          
          <div class="d-flex justify-content-center mb-3">
            <div class="me-4 text-center">
              <h4 class="mb-0 text-primary"><%= user.eloRating %></h4>
              <small class="text-muted">ELO-Rating</small>
            </div>
            <div class="text-center">
              <h4 class="mb-0 text-primary">#<%= rank %></h4>
              <small class="text-muted">Rang</small>
            </div>
          </div>
          
          <% 
            // Berechne, wann die nächste Inaktivitätsstrafe fällig wäre
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const daysSinceLastActivity = Math.floor((new Date() - user.lastActivity) / (1000 * 60 * 60 * 24));
            const daysUntilPenalty = 7 - daysSinceLastActivity;
            
            // Prüfe, ob der Benutzer inaktiv ist oder bald inaktiv wird
            const isInactive = user.lastActivity < sevenDaysAgo;
            const soonInactive = daysSinceLastActivity >= 4 && daysSinceLastActivity < 7; // Warnung 3 Tage vorher
          %>

          <% if (isInactive) { %>
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Inaktivität erkannt!</strong> Du hast in den letzten 7 Tagen kein Spiel gespielt. 
              Dein ELO-Rating wird aufgrund der Inaktivität um 10 Punkte reduziert.
              <div class="mt-2">
                <a href="/game/add" class="btn btn-outline-danger btn-sm">
                  <i class="fas fa-gamepad me-1"></i>Jetzt Spiel hinzufügen
                </a>
              </div>
            </div>
          <% } else if (soonInactive) { %>
            <div class="alert alert-warning">
              <i class="fas fa-clock me-2"></i>
              <strong>Inaktivitätswarnung!</strong> Du hast seit <%= daysSinceLastActivity %> Tagen kein Spiel eingetragen. 
              In <%= daysUntilPenalty %> <%= daysUntilPenalty === 1 ? 'Tag' : 'Tagen' %> wird dein ELO-Rating um 10 Punkte reduziert.
              <div class="mt-2">
                <a href="/game/add" class="btn btn-outline-warning btn-sm">
                  <i class="fas fa-gamepad me-1"></i>Jetzt Spiel hinzufügen
                </a>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </div>
    
    <div class="col-md-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">Statistiken</h2>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-4 mb-3 mb-md-0">
              <h3 class="text-primary mb-0"><%= stats.gamesPlayed %></h3>
              <p class="text-muted mb-0">Gespielte Spiele</p>
            </div>
            <div class="col-md-4 mb-3 mb-md-0">
              <h3 class="text-primary mb-0"><%= stats.gamesWon %></h3>
              <p class="text-muted mb-0">Gewonnene Spiele</p>
            </div>
            <div class="col-md-4">
              <h3 class="text-primary mb-0"><%= stats.winRate %>%</h3>
              <p class="text-muted mb-0">Gewinnrate</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Letzte Spiele</h2>
          <a href="/game/user/history" class="btn btn-sm btn-outline-primary">
            Alle ansehen
          </a>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Teams</th>
                  <th>Ergebnis</th>
                  <th>ELO-Änderung</th>
                </tr>
              </thead>
              <tbody>
                <% if (recentGames.length === 0) { %>
                  <tr>
                    <td colspan="4" class="text-center py-3">Noch keine Spiele gespielt</td>
                  </tr>
                <% } else { %>
                  <% recentGames.forEach(game => { %>
                    <tr>
                      <td>
                        <a href="/game/<%= game._id %>" class="text-decoration-none">
                          <%= moment(game.createdAt).format('D. MMM YYYY') %>
                        </a>
                      </td>
                      <td>
                        <div class="small">
                          <strong><%= game.team1[0].player.username %></strong> & 
                          <strong><%= game.team1[1].player.username %></strong>
                          <span class="text-muted">vs</span> 
                          <strong><%= game.team2[0].player.username %></strong> & 
                          <strong><%= game.team2[1].player.username %></strong>
                        </div>
                      </td>
                      <td>
                        <span class="<%= game.winner === 'team1' ? 'text-success' : 'text-danger' %>">
                          <%= game.score.team1 %>-<%= game.score.team2 %>
                        </span>
                      </td>
                      <td>
                        <% 
                          // Finde die ELO-Änderung des Benutzers
                          let eloChange = 0;
                          let playerTeam = '';
                          
                          // Überprüfe Team 1
                          game.team1.forEach(player => {
                            if (player.player._id.toString() === user._id.toString()) {
                              eloChange = player.eloChange;
                              playerTeam = 'team1';
                            }
                          });
                          
                          // Überprüfe Team 2
                          game.team2.forEach(player => {
                            if (player.player._id.toString() === user._id.toString()) {
                              eloChange = player.eloChange;
                              playerTeam = 'team2';
                            }
                          });
                          
                          const winner = game.winner;
                          const isWinner = playerTeam === winner;
                        %>
                        
                        <span class="<%= eloChange >= 0 ? 'text-success' : 'text-danger' %>">
                          <%= eloChange >= 0 ? '+' : '' %><%= eloChange %>
                        </span>
                      </td>
                    </tr>
                  <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Profil bearbeiten Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="/user/profile/update">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Profil bearbeiten</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schließen"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="username" class="form-label">Benutzername</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <input type="text" class="form-control" id="username" name="username" value="<%= user.username %>" required>
              </div>
              <div class="form-text">Dein Name wird öffentlich in der Rangliste angezeigt.</div>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Deine E-Mail-Adresse kann nicht geändert werden. Falls du deine E-Mail-Adresse ändern möchtest, kontaktiere bitte den Administrator.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Änderungen speichern
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

<%- include('../partials/footer') %>